---
AWSTemplateFormatVersion: '2010-09-09'
Description: |
  Create a RDS instance.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "VPC Information"
        Parameters:
          - VPCStackName
      -
        Label:
          default: "RDS Configuration"
        Parameters:
          - DBEngine
          - DBInstanceClass
          - DBInstanceID
          - DBUser
          - DBPassword
          - AllocatedStorage

    ParameterLabels:
      VPCStackName:
        default: "Name of stack used to create the VPC"
      DBEngine:
        default: "DB Engine"
      DBInstanceClass:
        default: "DB Instance Class"
      DBUser:
        default: "DB User"
      DBPassword:
        default: "DB Password"
      AllocatedStorage:
        default: "Storage size tp provision (def 100GB)"

Parameters:
  VPCStackName:
    Type: String
    Description: "Name of the stack used to create and configure the VPC"
  DBEngine:
    Type: String
    Description: "Database Engine"
    AllowedValues: [ "mariadb", "mysql", "postgres" ]
    Default: "postgres"
  DBInstanceClass:
    Type: String
    Description: "DB Instance Class"
    AllowedValues: [ "db.t2.micro", "db.t2.small", "db.t2.medium", "db.t2.large", "db.t2.xlarge" ]
    Default: "db.t2.micro"
  DBInstanceID:
    Type: String
    Description: "Database Name"
    MinLength: 6
    MaxLength: 63
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters and be between 6 and 63 characters long.
  DBUser:
    Type: String
    Description: "Database User"
    MinLength: 4
    MaxLength: 16
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters and be between 6 and 16 characters long.
  DBPassword:
    Type: String
    Description: "Database Password"
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=]).{10,40}$'
    ConstraintDescription: must contain a number, lowercase, uppercase, special character (but no /, @ or double quote), no whitespace and be between 10 and 40 characters long.
    NoEcho: true
  AllocatedStorage:
    Type: Number
    Default: 100
    Descriptiont: "Volume size (GB) t0 provision (default 100)"

Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: DBSubnetGroup
      SubnetIds:
        - Fn::ImportValue:
            !Sub "${VPCStackName}-RDSSubnetAZ1"
        - Fn::ImportValue:
            !Sub "${VPCStackName}-RDSSubnetAZ2"
        - Fn::ImportValue:
            !Sub "${VPCStackName}-RDSSubnetAZ3"
      Tags:
        - Key: "Application"
          Value:
            Fn::ImportValue:
              !Sub "${VPCStackName}-Application"
        - Key: "Environment"
          Value:
            Fn::ImportValue:
              !Sub "${VPCStackName}-Environment"
  RDS:
    Type: AWS::RDS::DBInstance
    Properties: 
      AllocatedStorage: !Ref AllocatedStorage
      DBInstanceIdentifier: !Ref DBInstanceID
      DBInstanceClass: !Ref DBInstanceClass
      Engine: !Ref DBEngine
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref DBSubnetGroup
      StorageType: gp2
      VPCSecurityGroups:
        - Fn::ImportValue:
            !Sub "${VPCStackName}-SGRDS"
      Tags:
        - Key: "Name"
          Value: !Ref DBInstanceID
        - Key: "Application"
          Value:
            Fn::ImportValue:
              !Sub "${VPCStackName}-Application"
        - Key: "Environment"
          Value:
            Fn::ImportValue:
              !Sub "${VPCStackName}-Environment"

Outputs:
  RDS:
    Value: !Ref RDS
    Description: "RDS DBInstance"
    Export:
      Name: !Sub "${AWS::StackName}-RDS"
